# Stage 1: Development setup with hot reloading
FROM node:20.18.1-slim

# Setup the working directory
RUN mkdir -p /usr/src/app
WORKDIR /usr/src/app

# Install dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    python3 \
    nginx \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Install oauth2-proxy
RUN curl -L https://github.com/oauth2-proxy/oauth2-proxy/releases/download/v7.4.0/oauth2-proxy-v7.4.0.linux-amd64.tar.gz -o oauth2-proxy.tar.gz && \
    tar -xvzf oauth2-proxy.tar.gz && \
    mv oauth2-proxy-v7.4.0.linux-amd64/oauth2-proxy /usr/local/bin/ && \
    rm -rf oauth2-proxy-v7.4.0.linux-amd64 oauth2-proxy.tar.gz

# Create necessary directories
RUN mkdir -p /var/logs/nginx /var/www/html /etc/oauth2-proxy

# Copy all application files first (needed for preinstall.js and workspace setup)
COPY . .

# Install dependencies
RUN yarn config set workspaces-experimental true
RUN yarn install --frozen-lockfile

# Copy the dev entrypoint script
COPY ./platform/app/.recipes/Nginx-Orthanc-Keycloak/config/entrypoint-dev.sh /entrypoint-dev.sh
RUN chmod +x /entrypoint-dev.sh

# Expose necessary ports
EXPOSE 3000 80 443 4180

# Set the entrypoint script as the entrypoint
ENTRYPOINT ["/entrypoint-dev.sh"]
